<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <style>
      .deck,
      #draw {
        cursor: pointer;
      }
      .deck:hover,
      #draw:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div id="app"></div>
    <script>
      function getRandomInt(max) {
        return Math.floor(Math.random() * Math.floor(max))
      }
      function shuffleDeck(deck) {
        const len = deck.length
        let shuffled = []
        let card
        for (let i = 0; i < len; i++) {
          ;[card, deck] = getRandomCard(deck)
          shuffled.push(card)
        }
        return shuffled
      }
      function getRandomCard(deck) {
        const id = getRandomInt(deck.length)
        return [deck[id], [...deck.slice(0, id), ...deck.slice(id + 1)]]
      }
      ;(async function() {
        let data
        try {
          const response = await fetch('outer_rim_solo_decks.json')
          if (!response.ok) {
            throw new Error('Network response was not ok.')
          }
          data = await response.json()
        } catch (error) {
          console.log(
            'There has been a problem with your fetch operation: ',
            error.message
          )
        }
        return data
      })().then(({ sections, automa }) => {
        const automaNames = automa.map(({ name }) => name)
        const app = document.getElementById('app')
        loadList()
        function deckSelect({ target }) {
          if (target.classList.contains('deck')) {
            loadDeck(target.dataset.id)
          }
          app.removeEventListener('click', deckSelect)
        }
        function loadList() {
          app.innerHTML = `<section><header>Choose Your Deck</header><ul>${automaNames
            .map((name, i) => `<li class="deck" data-id=${i}>${name}</li>`)
            .join('')}</ul></section>`

          app.addEventListener('click', deckSelect)
        }

        function loadDeck(id) {
          const ai = automa[id]
          console.log(ai)
          let deck = shuffleDeck(ai.deck)
          let discard = []
          console.log(deck)
          const drawCard = function() {
            const drawnCard = deck.shift()
            deck.push(drawnCard)

            const card = document.getElementById('card')
            card.innerHTML = ''
            sections.forEach(({ title, id, description, ordered }) => {
              if (drawnCard[id].length) {
                card.innerHTML += `<div><div class="title"><b>${title}</b>`
                if (description) {
                  card.innerHTML += ` - <span>${description}</span></div>`
                }
                card.innerHTML += `<${ordered ? 'ol' : 'ul'}>${drawnCard[id]
                  .map(s => `<li>${s}</li>`)
                  .join('')}</${ordered ? 'ol' : 'ul'}></div>`
              }
            })
            card.innerHTML += `<div id="card-number">${drawnCard.card}</div>`

            if (drawnCard.shuffle) {
              deck = shuffleDeck(deck)
            }
          }
          app.innerHTML = `<section><header>${
            ai.name
          }</header><div id="notes"><ul>${ai.notes
            .map(n => `<li>${n}</li>`)
            .join(
              ''
            )}</ul></div><div id="draw">Draw Card</div><div id="card"></div></section>`
          const drawButton = document.getElementById('draw')
          const drawHandle = function(event) {
            drawCard()
          }
          drawButton.addEventListener('click', drawHandle)
        }
      })
    </script>
  </body>
</html>
